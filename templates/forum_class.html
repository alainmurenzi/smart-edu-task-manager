{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-comments"></i> {{ class_obj.name }} - Class Forum</h2>
            <p class="text-muted">Discuss with your classmates and teachers</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Chat Area -->
        <div class="col-md-8">
            <!-- Chat Messages Area -->
            <div class="card forum-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> Discussion</h5>
                </div>
                <div class="card-body forum-messages" id="messages-container">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="forum-message {% if message.user_id == current_user.id %}own-message{% endif %}">
                                <div class="message-header">
                                    <strong>{{ message.user.name }}</strong>
                                    <span class="text-muted small">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                <div class="message-content">
                                    {{ message.content }}
                                </div>
                                {% if message.user_id == current_user.id or current_user.user_type == 'admin' %}
                                <div class="message-actions">
                                    {% if message.user_id == current_user.id %}
                                    <a href="{{ url_for('forum.edit_message', message_id=message.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    {% endif %}
                                    <form action="{{ url_for('forum.delete_message', message_id=message.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this message?')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comment-slash fa-3x mb-3"></i>
                            <p>No messages yet. Be the first to start a discussion!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Message Input Form -->
            <div class="card mt-4">
                <div class="card-body">
                    <form action="{{ url_for('forum.post_class_message', class_id=class_obj.id) }}" method="POST">
                        <div class="form-group">
                            <label for="content"><i class="fas fa-pen"></i> Post a Message</label>
                            <textarea class="form-control" id="content" name="content" rows="3" 
                                      placeholder="Share your thoughts, ask questions, or help your classmates..."></textarea>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Members -->
        <div class="col-md-4">
            <!-- Active Members -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-user-check"></i> Active Now ({{ students|selectattr('is_active_forum')|list|length + teachers|selectattr('is_active_forum')|list|length }})</h6>
                </div>
                <div class="card-body sidebar-members">
                    {% set active_count = 0 %}
                    {% for student in students %}
                        {% if student.is_active_forum %}
                            {% set active_count = active_count + 1 %}
                            <div class="member-item active">
                                <div class="member-avatar">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                                <div class="member-info">
                                    <span class="member-name">{{ student.name }}</span>
                                    <span class="member-role badge badge-success badge-sm">Student</span>
                                </div>
                                <span class="status-indicator active"></span>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% for teacher in teachers %}
                        {% if teacher.is_active_forum %}
                            {% set active_count = active_count + 1 %}
                            <div class="member-item active">
                                <div class="member-avatar">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                                <div class="member-info">
                                    <span class="member-name">{{ teacher.name }}</span>
                                    <span class="member-role badge badge-primary badge-sm">Teacher</span>
                                </div>
                                <span class="status-indicator active"></span>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% if active_count == 0 %}
                        <p class="text-muted text-center mb-0">No active members</p>
                    {% endif %}
                </div>
            </div>

            <!-- All Members -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-users"></i> All Members ({{ students|length + teachers|length }})</h6>
                </div>
                <div class="card-body sidebar-members">
                    <h6 class="text-muted mt-2">Teachers</h6>
                    {% for teacher in teachers %}
                        <div class="member-item {% if teacher.is_active_forum %}active{% else %}inactive{% endif %}">
                            <div class="member-avatar">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="member-info">
                                <span class="member-name">{{ teacher.name }}</span>
                            </div>
                            <span class="status-indicator {% if teacher.is_active_forum %}active{% else %}inactive{% endif %}"></span>
                        </div>
                    {% endfor %}
                    
                    <h6 class="text-muted mt-3">Students</h6>
                    {% for student in students %}
                        <div class="member-item {% if student.is_active_forum %}active{% else %}inactive{% endif %}">
                            <div class="member-avatar">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="member-info">
                                <span class="member-name">{{ student.name }}</span>
                            </div>
                            <span class="status-indicator {% if student.is_active_forum %}active{% else %}inactive{% endif %}"></span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Forum Guidelines -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Forum Guidelines</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Be respectful and professional in your communications</li>
                        <li>Stay on topic and contribute constructively</li>
                        <li>Avoid sharing personal information</li>
                        <li>Teachers and administrators can view all messages</li>
                        <li>Report any inappropriate content to your teacher</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.forum-card {
    max-height: 500px;
    display: flex;
    flex-direction: column;
}

.forum-messages {
    flex: 1;
    overflow-y: auto;
    max-height: 450px;
    padding: 15px;
}

.forum-message {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border-left: 4px solid #007bff;
}

.forum-message.own-message {
    background-color: #e3f2fd;
    border-left-color: #28a745;
    margin-left: 20px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.message-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.sidebar-members {
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
}

.member-item {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    border-radius: 8px;
    margin-bottom: 5px;
    background-color: #f8f9fa;
}

.member-item.active {
    background-color: #d4edda;
}

.member-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    color: #6c757d;
}

.member-item.active .member-avatar {
    background-color: #c3e6cb;
    color: #155724;
}

.member-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.member-name {
    font-weight: 500;
    font-size: 0.9em;
}

.member-role {
    font-size: 0.7em;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: 8px;
}

.status-indicator.active {
    background-color: #28a745;
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
}

.status-indicator.inactive {
    background-color: #6c757d;
}

.badge-sm {
    font-size: 0.7em;
    padding: 0.2em 0.4em;
}

.message-actions {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid #dee2e6;
}

.message-actions .btn {
    margin-right: 5px;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
});
</script>
{% endblock %}
